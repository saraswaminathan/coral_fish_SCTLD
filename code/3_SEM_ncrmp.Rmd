---
title: "3. Full SEM of NCRMP data"
author: "Sara Devi Swaminathan"
date: "`r Sys.Date()`"
output: html_document
toc: true
toc_float: true
number_sections: true
---

#Set working directory to project directory and load packages

```{r}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

library(knitr)
library(tidyverse)
library(Hmisc)
library(brms)
library(parallel)
library(ggridges)
library(loo)
library(bayesplot)
```

# Load data and set instructions for sampler
```{r}
ncrmp <- read_csv("data/outputs/ncrmp_simple.csv")

logit <- function(mu){
  logit.mu <- log(mu/(1-mu))
}

#-Sampler instructions-#
n_cores <- detectCores() 
n_chains <- 2 
n_iter <- 4000
n_warmup <- 2000
```

# Build individual models

## SCTLD-susceptible coral
```{r, message = FALSE}
################################################################################
#-Build individual models-######################################################
################################################################################

#-Susceptible coral-############################################################

suscCoral_mod <- bf(propSusc ~  1 + 
                      (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                    phi ~ 1 + 
                      (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                    zi ~ 1 + 
                      (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                    family = zero_inflated_beta(link = "logit", link_phi = "log", link_zi = "logit"))

get_prior(suscCoral_mod, data = ncrmp)

propSusc_mean <- ncrmp %>%
  dplyr::group_by(SUB_REGION_NAME) %>%
  dplyr::summarize(mean = mean(propSusc)) %>%
  mutate(logitmean = logit(mean))

print(paste("The logit-transformed propSusc intercept is", round(propSusc_mean[1,3], 2)))
# "The logit-transformed propSusc intercept is -2.06"

susc_prior <- c(prior(normal(-2.1, 1), class = "Intercept"),
                prior(normal(0, 1), class = "b"),
                prior(normal(0, 2), class = "sds"),
                prior(exponential(2), class = "sd"),
                prior(logistic(0, 1), class = "Intercept", dpar = "zi"),
                prior(exponential(2), class = "sd", dpar = "zi"),
                prior(normal(0, 2), class = "sds", dpar = "zi"))


susc_prior$resp <- "propSusc"
```

## SCTLD-resistant coral

```{r, message = FALSE}
#-Resistant coral-##############################################################

resistantCoral_mod <- bf(propResistant ~  1 + 
                           (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                         phi ~ 1 + 
                           (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                         zi ~ 1 + 
                           (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                         family = zero_inflated_beta(link = "logit", link_phi = "log", link_zi = "logit"))

get_prior(resistantCoral_mod, data = ncrmp) 

propResistant_mean <- ncrmp %>%
  dplyr::group_by(SUB_REGION_NAME) %>%
  dplyr::summarize(mean = mean(propResistant)) %>%
  mutate(logitmean = logit(mean))

print(paste("The logit-transformed propResistant intercept is", round(propResistant_mean[1,3], 2)))
# "The logit-transformed propResistant intercept is -3.69"

resistant_prior <- c(prior(normal(-3.7, 1), class = "Intercept"),
                     prior(normal(0, 1), class = "b"),
                     prior(normal(0, 2), class = "sds"),
                     prior(exponential(2), class = "sd"),
                     prior(logistic(0, 1), class = "Intercept", dpar = "zi"),
                     prior(exponential(2), class = "sd", dpar = "zi"),
                     prior(normal(0, 2), class = "sds", dpar = "zi"))

resistant_prior$resp <- "propResistant"
```

## Cyanobacteria

```{r, message = FALSE}
#-Cyanobacteria-################################################################

cyano_mod <- bf(cyanobacteria ~ 1  + rugosity_GC + mean_SR_rugosity +
                  susc_GC + mean_SR_susc_cover +
                  resistant_GC + mean_SR_resistant_cover +
                  (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                phi ~ 1  + rugosity_GC + mean_SR_rugosity +
                  susc_GC + mean_SR_susc_cover +
                  resistant_GC + mean_SR_resistant_cover +
                  (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                zi ~ 1  + rugosity_GC + mean_SR_rugosity +
                  susc_GC + mean_SR_susc_cover +
                  resistant_GC + mean_SR_resistant_cover +
                  (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                family = zero_inflated_beta(link = "logit", link_phi = "log", link_zi = "logit"))

cyano_mean <- ncrmp %>%
  dplyr::group_by(SUB_REGION_NAME) %>%
  dplyr::summarize(mean = mean(cyanobacteria)) %>%
  mutate(logit_mean = logit(mean))

print(paste("The logit-transformed cyanobacteria intercept is", round(cyano_mean[1,3],2)))
#""The logit-transformed cyanobacteria intercept is -1.47"

get_prior(cyano_mod, data = ncrmp) 

cyano_prior <- c(prior(normal(-1.5, 1), class = "Intercept"),
                      prior(normal(0, 1), class = "b"),
                      prior(exponential(2), class = "sd"),
                      prior(normal(0, 2), class = "sds"),
                      prior(logistic(0, 1), class = "Intercept", dpar = "zi"),
                      prior(exponential(2), class = "sd", dpar = "zi"),
                      prior(normal(0, 2), class = "sds", dpar = "zi"))

cyano_prior$resp <- "cyanobacteria"   
```

## CCA

```{r, message = FALSE}
#-CCA-##########################################################################

cca_mod <- bf(CCA ~ 1  + rugosity_GC + mean_SR_rugosity +
                susc_GC + mean_SR_susc_cover +
                resistant_GC + mean_SR_resistant_cover +
                (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
              zi ~ 1  + rugosity_GC + mean_SR_rugosity +
                susc_GC + mean_SR_susc_cover +
                resistant_GC + mean_SR_resistant_cover +
                (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
              phi ~ 1  + rugosity_GC + mean_SR_rugosity +
                susc_GC + mean_SR_susc_cover +
                resistant_GC + mean_SR_resistant_cover +
                (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
              family = zero_inflated_beta(link = "logit", link_phi = "log", link_zi = "logit"))

CCA_mean <- ncrmp %>%
  dplyr::group_by(SUB_REGION_NAME) %>%
  dplyr::summarize(mean = mean(CCA)) %>%
  mutate(logit_mean = logit(mean))

print(paste("The logit-transformed CCA intercept is", round(CCA_mean[1,3], 2)))
# "The logit-transformed CCA intercept is -2.99"

get_prior(cca_mod, data = ncrmp)

cca_brm_priors <- c(prior(normal(-3, 1), class = "Intercept"),
                    prior(normal(0, 1), class = "b"),
                    prior(exponential(2), class = "sd"),
                    prior(normal(0, 2), class = "sds"),
                    prior(logistic(0, 1), class = "Intercept", dpar = "zi"),
                    prior(exponential(2), class = "sd", dpar = "zi"),
                    prior(normal(0, 2), class = "sds", dpar = "zi"))

cca_prior <- cca_brm_priors
cca_prior$resp <- "CCA"
```

## Macroalgae

```{r, message = FALSE}
#-Macroalgae-###################################################################

macro_mod <- bf(macroalgae ~ 1  + rugosity_GC + mean_SR_rugosity +
                  susc_GC + mean_SR_susc_cover +
                  resistant_GC + mean_SR_resistant_cover +
                  (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                zi ~ 1  + rugosity_GC + mean_SR_rugosity +
                  susc_GC + mean_SR_susc_cover +
                  resistant_GC + mean_SR_resistant_cover +
                  (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                phi ~ 1  + rugosity_GC + mean_SR_rugosity +
                  susc_GC + mean_SR_susc_cover +
                  resistant_GC + mean_SR_resistant_cover +
                  (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                family = zero_inflated_beta(link = "logit", link_phi = "log", link_zi = "logit"))

macroalgae_mean <- ncrmp %>%
  dplyr::group_by(SUB_REGION_NAME) %>%
  dplyr::summarize(mean = mean(macroalgae)) %>%
  mutate(logit_mean = logit(mean))

print(paste("The logit-transformed macroalgae intercept is", round(macroalgae_mean[1,3], 2)))
# "The logit-transformed macroalgae intercept is -0.95"

get_prior(macro_mod, data = ncrmp)

macro_prior <- c(prior(normal(-1, 1), class = "Intercept"),
                      prior(normal(0, 1), class = "b"),
                      prior(exponential(2), class = "sd"),
                      prior(normal(0, 2), class = "sds"),
                      prior(logistic(0, 1), class = "Intercept", dpar = "zi"),
                      prior(exponential(2), class = "sd", dpar = "zi"),
                      prior(normal(0, 2), class = "sds", dpar = "zi"))

macro_prior$resp <- "macroalgae"     
```

## Fire coral

```{r, message = FALSE}
#-Fire coral-###################################################################

fire_mod <- bf(fireCoral ~ 1  + rugosity_GC + mean_SR_rugosity +
                 susc_GC + mean_SR_susc_cover +
                 resistant_GC + mean_SR_resistant_cover +
                 (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
               zi ~ 1  + rugosity_GC + mean_SR_rugosity +
                 susc_GC + mean_SR_susc_cover +
                 resistant_GC + mean_SR_resistant_cover +
                 (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
               phi ~ 1  + rugosity_GC + mean_SR_rugosity +
                 susc_GC + mean_SR_susc_cover +
                 resistant_GC + mean_SR_resistant_cover +
                 (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
               family = zero_inflated_beta(link = "logit", link_phi = "log", link_zi = "logit"))


fireCoral_mean <- ncrmp %>%
  dplyr::group_by(SUB_REGION_NAME) %>%
  dplyr::summarize(mean = mean(fireCoral)) %>%
  mutate(logit_mean = logit(mean))

print(paste("The logit-transformed fireCoral intercept is", round(fireCoral_mean[1,3], 2)))
# "The logit-transformed fireCoral intercept is -5.16


get_prior(fire_mod, data = ncrmp)

fire_prior <- c(prior(normal(-5.2, 1), class = "Intercept"),
                     prior(normal(0, 1), class = "b"),
                     prior(normal(0, 2), class = "sds"),
                     prior(exponential(2), class = "sd"),
                     prior(logistic(0, 1), class = "Intercept", dpar = "zi"),
                     prior(exponential(2), class = "sd", dpar = "zi"),
                     prior(normal(0, 2), class = "sds", dpar = "zi"))

fire_prior$resp <- "fireCoral"
```

## Rugosity

```{r, message = FALSE}
#-Rugosity-#####################################################################

rug_mod <- bf(logNewRug ~ 1 + susc_GC + mean_SR_susc_cover + 
                        resistant_GC + mean_SR_resistant_cover +
                        rugosityMethod + (1|SUB_REGION_NAME) + (1|YEAR),
                      sigma ~ 1 + susc_GC + mean_SR_susc_cover + 
                        resistant_GC + mean_SR_resistant_cover + 
                        rugosityMethod + (1|SUB_REGION_NAME) + (1|YEAR),family = student())


get_prior(rug_mod, data = ncrmp) 

logNewRug_mean <- ncrmp %>%
  dplyr::group_by(SUB_REGION_NAME) %>%
  dplyr::summarize(mean = mean(logNewRug))

print(paste("The logNewRug intercept is", round(logNewRug_mean[1,2], 2)))
# "The logNewRug intercept is -0.95

rug_prior <- c(prior(normal(-1, 1), class = "Intercept"), 
               prior(normal(0, 1), class = "b"), 
               prior(exponential(1), class = "sd"), 
               prior(normal(-1, 1), class = "Intercept", dpar = "sigma"), 
               prior(exponential(1), class = "sd", dpar = "sigma")) 

rug_prior$resp <- "logNewRug"
```

## Coral-associated fish

```{r, message = FALSE}
#-Coral associated fish-########################################################

coralAssoc_mod<- bf(coralAssociated ~  1 + 
                      rugosity_GC+ mean_SR_rugosity + rugosityMethod +
                      susc_GC + mean_SR_susc_cover + 
                      resistant_GC + mean_SR_resistant_cover + 
                      mean_SR_cyano + cyano_GC + 
                      mean_SR_cca + cca_GC + 
                      mean_SR_macro + macro_GC + 
                      mean_SR_fire + fire_GC + 
                      (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                    shape ~ 1 + 
                      rugosity_GC+ mean_SR_rugosity + rugosityMethod +
                      susc_GC + mean_SR_susc_cover + 
                      resistant_GC + mean_SR_resistant_cover + 
                      mean_SR_cyano + cyano_GC + 
                      mean_SR_cca + cca_GC + 
                      mean_SR_macro + macro_GC + 
                      mean_SR_fire + fire_GC + 
                      (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                    hu ~ 1 + 
                      rugosity_GC+ mean_SR_rugosity + rugosityMethod +
                      susc_GC + mean_SR_susc_cover + 
                      resistant_GC + mean_SR_resistant_cover + 
                      mean_SR_cyano + cyano_GC + 
                      mean_SR_cca + cca_GC + 
                      mean_SR_macro + macro_GC + 
                      mean_SR_fire + fire_GC + 
                      (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                    family = hurdle_gamma(link = "log", link_shape = "log", link_hu = "logit"))


get_prior(coralAssoc_mod, data = ncrmp)


coralAssociated_mean <- ncrmp %>%
  dplyr::group_by(SUB_REGION_NAME) %>%
  dplyr::summarize(mean = mean(coralAssociated)) %>%
  mutate(logmean = log(mean))

print(paste("The log-transformed coralAssociated intercept is", round(coralAssociated_mean[1,3], 2)))
# "The log-transformed coralAssociated intercept is 2.31"


coralAssoc_prior <- c(prior(normal(2.3, 1), class = "Intercept"),
                      prior(normal(0, 1), class = "b"),
                      prior(normal(0, 2), class = "sds"),
                      prior(exponential(1), class = "sd"),
                      prior(normal(2.3, 1), class = "Intercept", dpar = "shape"),
                      prior(exponential(1), class = "sd", dpar = "shape"), 
                      prior(normal(0, 1), class = "b", dpar = "shape"))
coralAssoc_prior$resp <- "coralAssociated"
```

## Herbivorous fish

```{r, message = FALSE}
#-Herbivorous fishes-###########################################################

herb_mod <- bf(herb ~ 1 + mean_SR_rugosity + rugosity_GC + 
                 susc_GC + mean_SR_susc_cover + 
                 resistant_GC + mean_SR_resistant_cover + 
                 mean_SR_cyano + cyano_GC + 
                 mean_SR_cca + cca_GC + 
                 mean_SR_macro + macro_GC + 
                 mean_SR_fire + fire_GC + 
                 (1 | SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
               shape ~ 1 + mean_SR_rugosity + rugosity_GC + 
                 susc_GC + mean_SR_susc_cover + 
                 resistant_GC + mean_SR_resistant_cover + 
                 mean_SR_cyano + cyano_GC + 
                 mean_SR_cca + cca_GC + 
                 mean_SR_macro + macro_GC + 
                 mean_SR_fire + fire_GC + 
                 (1 | SUB_REGION_NAME) + (1|YEAR)+ s(MAX_DEPTH),   
               family = hurdle_gamma(link = "log"))


get_prior(herb_mod, data = ncrmp)

herb_mean <- ncrmp %>%
  dplyr::group_by(SUB_REGION_NAME) %>%
  dplyr::summarize(mean = mean(herb)) %>%
  mutate(logmean = log(mean))

print(paste("The log-transformed herb intercept is", round(herb_mean[1,3], 2)))
# "The log-transformed herb intercept is -0.39"

herb_prior <- c(prior(normal(-0.4, 1), class = "Intercept"),
                prior(normal(0, 1), class = "b"),
                prior(normal(0, 2), class = "sds"),
                prior(exponential(1), class = "sd"),
                prior(beta(1, 1), class = "hu"),
                prior(normal(-0.4, 1), class = "Intercept", dpar = "shape"),
                prior(exponential(1), class = "sd", dpar = "shape"), 
                prior(normal(0, 1), class = "b", dpar = "shape"))


herb_prior$resp <- "herb"
```

## Other fish

```{r, message = FALSE}
#-Other fish-###################################################################

otherFish_mod <- bf(otherFish ~ 1 + 
                            rugosity_GC+ mean_SR_rugosity + rugosityMethod +
                            susc_GC + mean_SR_susc_cover + 
                            resistant_GC + mean_SR_resistant_cover + 
                            mean_SR_cyano + cyano_GC + 
                            mean_SR_cca + cca_GC + 
                            mean_SR_macro + macro_GC + 
                            mean_SR_fire + fire_GC + 
                            (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                          shape ~ 1 + 
                            rugosity_GC+ mean_SR_rugosity + rugosityMethod +
                            susc_GC + mean_SR_susc_cover + 
                            resistant_GC + mean_SR_resistant_cover + 
                            mean_SR_cyano + cyano_GC + 
                            mean_SR_cca + cca_GC + 
                            mean_SR_macro + macro_GC + 
                            mean_SR_fire + fire_GC + 
                            (1|SUB_REGION_NAME) + (1|YEAR) + s(MAX_DEPTH),
                          family = Gamma(link = "log"))

get_prior(otherFish_mod, data = ncrmp)

otherFish_mean <- ncrmp %>%
  dplyr::group_by(SUB_REGION_NAME) %>%
  dplyr::summarize(mean = mean(otherFish)) %>%
  mutate(logmean = log(mean))

print(paste("The log-transformed otherFish intercept is", round(otherFish_mean[1,3], 2)))
# "The log-transformed otherFish intercept is 3.49

otherFish_prior <- c(prior(normal(3.5, 1), class = "Intercept"),
                     prior(normal(0, 1), class = "b"),
                     prior(normal(0, 2), class = "sds"),
                     prior(exponential(1), class = "sd"),
                     prior(normal(3.1, 1), class = "Intercept", dpar ="shape"), 
                     prior(normal(0, 1), class = "b", dpar = "shape"),
                     prior(exponential(1), class = "sd", dpar = "shape"))

otherFish_prior$resp <- "otherFish"
```

# Build and run full SEM
```{r, message = FALSE}
################################################################################
#-Build full SEM-###############################################################
################################################################################

full_priors <- c( susc_prior,
                  resistant_prior,
                  cyano_prior, 
                 cca_prior,
                 macro_prior, 
                 fire_prior, 
                 rug_prior, 
                 coralAssoc_prior,
                herb_prior,
                otherFish_prior)
full_priors

### UNCOMMENT BELOW TO RUN MODEL
# full_SEM <- brm(cyano_mod + 
#                 rug_mod + 
#                 cca_mod + 
#                 fire_mod + 
#                 macro_mod + 
#                 otherFish_mod + 
#                 coralAssoc_mod + 
#                 herb_mod +
#                 resistantCoral_mod + 
#                 suscCoral_mod +
#                 set_rescor(rescor = FALSE),
#                         prior = full_priors,
#                         data = ncrmp,
#                         cores = n_cores,
#                         chains = n_chains,
#                         iter = n_iter,
#                         warmup = n_warmup,
#                         init = "0",
#                         control = list(adapt_delta = 0.99))

## save to file
full_SEM <- readRDS("data/outputs/full_SEM.rds")
#saveRDS(full_SEM, "data/outputs/full_SEM.rds")
```

# Posterior predictive checks
## SCTLD-susceptible coral

```{r, message = FALSE}
pp_check(full_SEM, ndraws = 100,resp = 'propSusc', type = "dens_overlay")+ 
  labs(title = "Sctld-susceptible coral")

pp_check(full_SEM, ndraws = 100,resp = 'propSusc', type = "hist")+ 
  labs(title = "Sctld-susceptible coral")

pp_check(full_SEM, ndraws = 100,resp = 'propSusc', type = "boxplot")+ 
  labs(title = "Sctld-susceptible coral")

y <- t(posterior_predict(full_SEM, resp = 'propSusc')*100)
all_col_indices <- 1:ncol(y)
# Randomly select 1637 row indices from the vector of all indices
selected_col_indices <- sample(all_col_indices, size = 1637)
# Subset the DataFrame using the selected row indices
selected_cols <- y[,selected_col_indices ]
yrep_int <- sapply(data.frame(selected_cols), as.integer)
y_int <- as.integer(ncrmp$propSusc*100)
length(y_int) 
ncol(yrep_int)
ppc_bars(y_int, yrep_int)
ppc_rootogram(y_int, yrep_int)
```

## SCTLD-resistant coral
```{r, message = FALSE}
pp_check(full_SEM, ndraws = 100,resp = 'propResistant', type = "dens_overlay")+ 
  labs(title = "Sctld-resistant coral")

pp_check(full_SEM, ndraws = 100,resp = 'propResistant', type = "hist")+ 
  labs(title = "Sctld-resistant coral")

pp_check(full_SEM, ndraws = 100,resp = 'propResistant', type = "boxplot")+ 
  labs(title = "Sctld-resistant coral")

y <- t(posterior_predict(full_SEM, resp = 'propResistant')*100)
all_col_indices <- 1:ncol(y)
# Randomly select 1637 row indices from the vector of all indices
selected_col_indices <- sample(all_col_indices, size = 1637)
# Subset the DataFrame using the selected row indices
selected_cols <- y[,selected_col_indices ]
yrep_int <- sapply(data.frame(selected_cols), as.integer)
y_int <- as.integer(ncrmp$propResistant*100)
length(y_int) 
ncol(yrep_int)
ppc_bars(y_int, yrep_int)
ppc_rootogram(y_int, yrep_int)

```

## cyanobacteria
```{r, message = FALSE}
pp_check(full_SEM, ndraws = 100,resp = 'cyanobacteria', type = "dens_overlay")+ 
  labs(title = "cyanobacteria")

pp_check(full_SEM, ndraws = 100,resp = 'cyanobacteria', type = "hist")+ 
  labs(title = "cyanobacteria")

pp_check(full_SEM, ndraws = 100,resp = 'cyanobacteria', type = "boxplot")+ 
  labs(title = "cyanobacteria")

y <- t(posterior_predict(full_SEM, resp = 'cyanobacteria')*100)
all_col_indices <- 1:ncol(y)
# Randomly select 1637 row indices from the vector of all indices
selected_col_indices <- sample(all_col_indices, size = 1637)
# Subset the DataFrame using the selected row indices
selected_cols <- y[,selected_col_indices ]
yrep_int <- sapply(data.frame(selected_cols), as.integer)
y_int <- as.integer(ncrmp$cyanobacteria*100)
length(y_int) 
ncol(yrep_int)
ppc_bars(y_int, yrep_int)
ppc_rootogram(y_int, yrep_int)
```

## CCA
```{r, message = FALSE}
pp_check(full_SEM, ndraws = 100,resp = 'CCA', type = "dens_overlay")+ 
  labs(title = "cca")

pp_check(full_SEM, ndraws = 100,resp = 'CCA', type = "hist")+ 
  labs(title = "cca")

pp_check(full_SEM, ndraws = 100,resp = 'CCA', type = "boxplot")+ 
  labs(title = "cca")

y <- t(posterior_predict(full_SEM, resp = 'CCA')*100)
all_col_indices <- 1:ncol(y)
# Randomly select 1637 row indices from the vector of all indices
selected_col_indices <- sample(all_col_indices, size = 1637)
# Subset the DataFrame using the selected row indices
selected_cols <- y[,selected_col_indices ]
yrep_int <- sapply(data.frame(selected_cols), as.integer)
y_int <- as.integer(ncrmp$CCA*100)
length(y_int) 
ncol(yrep_int)
ppc_bars(y_int, yrep_int)
ppc_rootogram(y_int, yrep_int)
```

## macroalgae
```{r, message = FALSE}
pp_check(full_SEM, ndraws = 100,resp = 'macroalgae', type = "dens_overlay")+ 
  labs(title = "macroalgae")

pp_check(full_SEM, ndraws = 100,resp = 'macroalgae', type = "hist")+ 
  labs(title = "macroalgae")

pp_check(full_SEM, ndraws = 100,resp = 'macroalgae', type = "boxplot")+ 
  labs(title = "macroalgae")

y <- t(posterior_predict(full_SEM, resp = 'macroalgae')*100)
all_col_indices <- 1:ncol(y)
# Randomly select 1637 row indices from the vector of all indices
selected_col_indices <- sample(all_col_indices, size = 1637)
# Subset the DataFrame using the selected row indices
selected_cols <- y[,selected_col_indices ]
yrep_int <- sapply(data.frame(selected_cols), as.integer)
y_int <- as.integer(ncrmp$macroalgae*100)
length(y_int) 
ncol(yrep_int)
ppc_bars(y_int, yrep_int)
ppc_rootogram(y_int, yrep_int)
```

## fire coral
```{r, message = FALSE}
pp_check(full_SEM, ndraws = 100,resp = 'fireCoral', type = "dens_overlay")+ 
 
  labs(title = "fire coral")

pp_check(full_SEM, ndraws = 100,resp = 'fireCoral', type = "hist")+ 
 
  labs(title = "fire coral")

pp_check(full_SEM, ndraws = 100,resp = 'fireCoral', type = "boxplot")+ 
 
  labs(title = "fire coral")

y <- t(posterior_predict(full_SEM, resp = 'fireCoral')*100)
all_col_indices <- 1:ncol(y)
# Randomly select 1637 row indices from the vector of all indices
selected_col_indices <- sample(all_col_indices, size = 1637)
# Subset the DataFrame using the selected row indices
selected_cols <- y[,selected_col_indices ]
yrep_int <- sapply(data.frame(selected_cols), as.integer)
y_int <- as.integer(ncrmp$fireCoral*100)
length(y_int) 
ncol(yrep_int)
ppc_bars(y_int, yrep_int)
ppc_rootogram(y_int, yrep_int)
```

## rugosity
```{r, message = FALSE}
pp_check(full_SEM, ndraws = 100,resp = 'logNewRug', type = "dens_overlay")+ 
  labs(title = "rugosity")

pp_check(full_SEM, ndraws = 100,resp = 'logNewRug', type = "hist")+ 
  labs(title = "rugosity")

pp_check(full_SEM, ndraws = 100,resp = 'logNewRug', type = "boxplot")+ 
  labs(title = "rugosity")

pp_check(full_SEM, ndraws = 100,resp = 'logNewRug', type = "loo_pit_overlay")+ 
  labs(title = "rugosity")

```

## coral-associated fish
```{r, message = FALSE}
pp_check(full_SEM, ndraws = 100,resp = 'coralAssociated', type = "dens_overlay")+ 
  labs(title = "coral-associated fish")

pp_check(full_SEM, ndraws = 100,resp = 'coralAssociated', type = "hist")+ 
  labs(title = "coral-associated fish")

pp_check(full_SEM, ndraws = 100,resp = 'coralAssociated', type = "boxplot")+ 
  labs(title = "coral-associated fish")

y <- t(posterior_predict(full_SEM, resp = 'coralAssociated')*100)
all_col_indices <- 1:ncol(y)
# Randomly select 1637 row indices from the vector of all indices
selected_col_indices <- sample(all_col_indices, size = 1637)
# Subset the DataFrame using the selected row indices
selected_cols <- y[,selected_col_indices ]
yrep_int <- sapply(data.frame(selected_cols), as.integer)
y_int <- as.integer(ncrmp$fireCoral*100)
length(y_int) 
ncol(yrep_int)
ppc_bars(y_int, yrep_int)
ppc_rootogram(y_int, yrep_int)
```

## herbivorous fish
```{r, message = FALSE}
pp_check(full_SEM, ndraws = 100,resp = 'herb', type = "dens_overlay")+ 
  labs(title = "herbivorous fish")

pp_check(full_SEM, ndraws = 100,resp = 'herb', type = "hist")+ 
  labs(title = "herbivorous fish")

pp_check(full_SEM, ndraws = 100,resp = 'herb', type = "boxplot")+ 
  labs(title = "herbivorous fish")

y <- t(posterior_predict(full_SEM, resp = 'herb')*100)
all_col_indices <- 1:ncol(y)
# Randomly select 1637 row indices from the vector of all indices
selected_col_indices <- sample(all_col_indices, size = 1637)
# Subset the DataFrame using the selected row indices
selected_cols <- y[,selected_col_indices ]
yrep_int <- sapply(data.frame(selected_cols), as.integer)
y_int <- as.integer(ncrmp$fireCoral*100)
length(y_int) 
ncol(yrep_int)
ppc_bars(y_int, yrep_int)
ppc_rootogram(y_int, yrep_int)
```

## other fish
```{r, message = FALSE}
pp_check(full_SEM, ndraws = 100,resp = 'otherFish', type = "dens_overlay")+ 
  labs(title = "otherFish")

pp_check(full_SEM, ndraws = 100,resp = 'otherFish', type = "hist")+ 
  labs(title = "otherFish")

pp_check(full_SEM, ndraws = 100,resp = 'otherFish', type = "boxplot")+ 
  labs(title = "otherFish")

pp_check(full_SEM, ndraws = 100,resp = 'otherFish', type = "loo_pit_overlay")+ 
  labs(title = "otherFish")
```

